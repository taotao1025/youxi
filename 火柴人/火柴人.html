<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç«æŸ´äººå¤§ä¹±æ–—ï¼ˆç»ˆæç‰ˆï¼‰</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
background: #f0f8ff;
font-family: sans-serif;
}
/* æˆ˜åœºå®¹å™¨ */
.battle-field {
position: relative;
width: 100%;
height: 220px;
background: #e0f7fa;
border-radius: 8px;
overflow: hidden;
}
.stick {
position: absolute;
width: 60px;
height: 120px;
transition: left 0.1s ease, top 0.1s ease;
}
/* ç©å®¶ç«æŸ´äººåˆå§‹ä½ç½® */
#p1 {
left: 20%;
top: calc(100% - 160px);
}
/* ç”µè„‘ç«æŸ´äººåˆå§‹ä½ç½® */
#p2 {
right: 20%;
top: calc(100% - 160px);
}

/* ç«æŸ´äººæ ·å¼ */
.head {
width: 24px;
height: 24px;
border: 3px solid #222;
border-radius: 50%;
position: absolute;
left: 18px;
top: 0;
}
.body {
width: 3px;
height: 50px;
background: #222;
position: absolute;
left: 30px;
top: 24px;
}
.arm {
width: 35px;
height: 3px;
background: #222;
position: absolute;
top: 35px;
}
.leg {
width: 35px;
height: 3px;
background: #222;
position: absolute;
top: 74px;
}
.left-arm { left: -5px; transform: rotate(-30deg); }
.right-arm { right: -5px; transform: rotate(30deg); }
.left-leg { left: -5px; transform: rotate(40deg); }
.right-leg { right: -5px; transform: rotate(-40deg); }

/* æ”»å‡»/å—ä¼¤/é˜²å¾¡/é¢„è­¦åŠ¨ç”» */
@keyframes attack {
0% { transform: translateX(0); }
50% { transform: translateX(30px); }
100% { transform: translateX(0); }
}
@keyframes hurt {
0%,100% { opacity: 1; }
50% { opacity: 0.4; }
}
@keyframes defend {
0%,100% { transform: scale(1); }
50% { transform: scale(1.05); border-color: #3b82f6; }
}
@keyframes attack-warning {
0%,100% { background: rgba(239, 68, 68, 0.5); }
50% { background: rgba(239, 68, 68, 0.8); }
}
.attack { animation: attack 0.4s; }
.hurt { animation: hurt 0.4s; }
.defend { 
  animation: defend 0.3s; 
  border: 2px solid #3b82f6;
  border-radius: 4px;
}
.attack-warning {
  position: absolute;
  width: 80px;
  height: 120px;
  left: -10px;
  top: 0;
  border-radius: 4px;
  animation: attack-warning 0.8s;
  z-index: 1;
  pointer-events: none;
}

/* é”®ç›˜æç¤ºæ ·å¼ */
.key-hint {
background: #e5e7eb;
padding: 2px 6px;
border-radius: 3px;
font-size: 12px;
border: 1px solid #9ca3af;
}
/* åœ°é¢æ ·å¼ */
.ground {
position: absolute;
bottom: 0;
width: 100%;
height: 10px;
background: #4d7c0f;
}

/* éš¾åº¦/å…³å¡é€‰æ‹©æ ·å¼ */
.level-select {
display: flex;
gap: 2px;
margin-bottom: 10px;
flex-wrap: wrap;
}
.level-btn {
padding: 4px 8px;
border-radius: 4px;
border: 1px solid #9ca3af;
background: #f3f4f6;
cursor: pointer;
font-size: 12px;
}
.level-btn.active {
background: #3b82f6;
color: white;
border-color: #2563eb;
}
.difficulty-btn {
padding: 4px 12px;
border-radius: 4px;
border: none;
color: white;
cursor: pointer;
font-size: 12px;
margin-right: 4px;
}
.difficulty-easy { background: #10b981; }
.difficulty-medium { background: #f59e0b; }
.difficulty-hard { background: #ef4444; }
.difficulty-btn.active {
box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
}

/* å…³å¡æç¤º */
.level-info {
font-weight: bold;
color: #374151;
margin-bottom: 8px;
}

/* é˜²å¾¡æŠ€èƒ½æ ·å¼ */
.defense-info {
color: #2563eb;
font-size: 12px;
margin-bottom: 8px;
font-weight: bold;
}
.defense-cooldown {
color: #ef4444;
font-size: 11px;
}
</style>
</head>
<body class="flex flex-col items-center py-8">

<h1 class="text-3xl font-bold mb-4">ğŸ”¥ç«æŸ´äººå¤§ä¹±æ–—ï¼ˆç»ˆæç‰ˆï¼‰ğŸ”¥</h1>
<!-- æ“ä½œæç¤ºï¼ˆæ–°å¢é˜²å¾¡æŠ€èƒ½ï¼‰ -->
<p class="text-gray-600 mb-2">æ“ä½œè¯´æ˜ï¼š<span class="key-hint">â†‘â†“â†â†’</span> å…¨æ–¹å‘ç§»åŠ¨ | <span class="key-hint">ç©ºæ ¼</span> æ”»å‡» | <span class="key-hint">R</span> é‡æ–°å¼€å§‹ | <span class="key-hint">Shift</span> é˜²å¾¡ï¼ˆå‡å…80%ä¼¤å®³ï¼‰</p>
<p class="defense-info">ğŸ’¡ é˜²å¾¡æœ‰5ç§’å†·å´ | ç”µè„‘æ”»å‡»å‰ä¼šå‡ºç°çº¢è‰²é¢„è­¦ï¼</p>

<div class="w-full max-w-xl bg-white rounded-xl shadow p-4">
  <!-- éš¾åº¦é€‰æ‹© -->
  <div class="mb-2">
    <span class="text-sm font-bold mr-2">éš¾åº¦ï¼š</span>
    <button class="difficulty-btn difficulty-easy active" onclick="setDifficulty('easy')">ç®€å•</button>
    <button class="difficulty-btn difficulty-medium" onclick="setDifficulty('medium')">ä¸­ç­‰</button>
    <button class="difficulty-btn difficulty-hard" onclick="setDifficulty('hard')">å›°éš¾</button>
  </div>

  <!-- å…³å¡é€‰æ‹© -->
  <div class="mb-4">
    <div class="level-info">å½“å‰å…³å¡ï¼š<span id="currentLevel">1</span>/5 | å‡»è´¥æ‰€æœ‰å…³å¡é€šå…³ï¼</div>
    <div class="level-select">
      <button class="level-btn active" onclick="gotoLevel(1)">1</button>
      <button class="level-btn" onclick="gotoLevel(2)">2</button>
      <button class="level-btn" onclick="gotoLevel(3)">3</button>
      <button class="level-btn" onclick="gotoLevel(4)">4</button>
      <button class="level-btn" onclick="gotoLevel(5)">5</button>
    </div>
  </div>

  <!-- è¡€æ¡ + é˜²å¾¡å†·å´æç¤º -->
  <div class="flex justify-between mb-2 text-sm font-bold">
    <div>ç©å®¶ <span id="hp1">100</span> <span id="defenseCooldown" class="defense-cooldown"></span></div>
    <div>ç”µè„‘ <span id="hp2">100</span></div>
  </div>
  <div class="flex gap-2 mb-6">
    <div class="w-1/2 h-4 bg-gray-200 rounded overflow-hidden">
      <div id="bar1" class="h-full bg-green-500" style="width:100%"></div>
    </div>
    <div class="w-1/2 h-4 bg-gray-200 rounded overflow-hidden">
      <div id="bar2" class="h-full bg-green-500" style="width:100%"></div>
    </div>
  </div>

  <!-- æˆ˜åœº -->
  <div class="battle-field relative w-full h-[220px] bg-blue-50 rounded overflow-hidden">
    <div class="ground"></div>
    <!-- ç©å®¶ç«æŸ´äºº -->
    <div id="p1" class="stick">
      <div class="head"></div>
      <div class="body"></div>
      <div class="arm left-arm"></div>
      <div class="arm right-arm"></div>
      <div class="leg left-leg"></div>
      <div class="leg right-leg"></div>
    </div>
    <!-- ç”µè„‘ç«æŸ´äººï¼ˆæ–°å¢é¢„è­¦å®¹å™¨ï¼‰ -->
    <div id="p2" class="stick">
      <div class="attack-warning" id="attackWarning" style="display: none;"></div>
      <div class="head"></div>
      <div class="body"></div>
      <div class="arm left-arm"></div>
      <div class="arm right-arm"></div>
      <div class="leg left-leg"></div>
      <div class="leg right-leg"></div>
    </div>
    <div id="msg" class="absolute top-10 left-1/2 -translate-x-1/2 bg-black/70 text-white px-3 py-1 rounded opacity-0 transition-opacity">æŒ‰â†‘â†“â†â†’ç§»åŠ¨ï¼Œç©ºæ ¼æ”»å‡»ï¼</div>
  </div>

  <!-- æŒ‰é’®ï¼ˆæ–°å¢é˜²å¾¡æŒ‰é’®ï¼‰ -->
  <div class="mt-4 flex justify-center gap-3">
    <button onclick="attack()" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded font-bold">æ”»å‡»</button>
    <button onclick="defend()" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded font-bold">é˜²å¾¡</button>
    <button onclick="resetGame()" class="bg-gray-500 hover:gray-600 text-white px-5 py-2 rounded">é‡æ–°å¼€å§‹</button>
  </div>
</div>

<script>
// æ¸¸æˆæ ¸å¿ƒé…ç½®
let gameState = {
  hp1: 100,          // ç©å®¶è¡€é‡
  hp2: 100,          // ç”µè„‘è¡€é‡
  gameOver: false,   // æ¸¸æˆç»“æŸæ ‡è¯†
  isAttacking: false,// æ”»å‡»å†·å´ï¼ˆç©å®¶+ç”µè„‘ï¼‰
  currentLevel: 1,   // å½“å‰å…³å¡ï¼ˆ1-5ï¼‰
  difficulty: 'easy',// å½“å‰éš¾åº¦ï¼ˆeasy/medium/hardï¼‰
  // å…³å¡é…ç½®ï¼šæ¯ä¸ªå…³å¡çš„ç”µè„‘å±æ€§ï¼ˆåŸºç¡€å€¼ + éš¾åº¦åŠ æˆï¼‰
  levelConfig: [
    { hp: 100, minDmg: 6, maxDmg: 10, attackSpeed: 800, activeAttackInterval: 3000, moveSpeed: 2 }, // å…³å¡1
    { hp: 120, minDmg: 7, maxDmg: 11, attackSpeed: 700, activeAttackInterval: 2500, moveSpeed: 2.5 }, // å…³å¡2
    { hp: 140, minDmg: 8, maxDmg: 12, attackSpeed: 600, activeAttackInterval: 2000, moveSpeed: 3 }, // å…³å¡3
    { hp: 160, minDmg: 9, maxDmg: 13, attackSpeed: 500, activeAttackInterval: 1500, moveSpeed: 3.5 }, // å…³å¡4
    { hp: 200, minDmg: 10, maxDmg: 15, attackSpeed: 400, activeAttackInterval: 1000, moveSpeed: 4 } // å…³å¡5
  ],
  // éš¾åº¦åŠ æˆ
  difficultyBonus: {
    easy: { hp: 0, dmg: 0, attackSpeed: 0, activeAttackInterval: 1000, moveSpeed: 0 },    // ç®€å•
    medium: { hp: 20, dmg: 2, attackSpeed: -100, activeAttackInterval: 500, moveSpeed: 0.5 }, // ä¸­ç­‰
    hard: { hp: 50, dmg: 4, attackSpeed: -200, activeAttackInterval: 0, moveSpeed: 1 }  // å›°éš¾
  },
  activeAttackTimer: null, // ç”µè„‘ä¸»åŠ¨æ”»å‡»çš„å®šæ—¶å™¨
  computerMoveTimer: null, // ç”µè„‘ä¸»åŠ¨ç§»åŠ¨çš„å®šæ—¶å™¨
  isDefending: false,      // ç©å®¶æ˜¯å¦åœ¨é˜²å¾¡
  defenseCooldown: 0,      // é˜²å¾¡å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
  defenseCooldownTimer: null // é˜²å¾¡å†·å´å®šæ—¶å™¨
};

// DOMå…ƒç´ 
const p1 = document.getElementById('p1');
const p2 = document.getElementById('p2');
const msg = document.getElementById('msg');
const battleField = document.querySelector('.battle-field');
const currentLevelEl = document.getElementById('currentLevel');
const levelBtns = document.querySelectorAll('.level-btn');
const difficultyBtns = document.querySelectorAll('.difficulty-btn');
const attackWarning = document.getElementById('attackWarning');
const defenseCooldownEl = document.getElementById('defenseCooldown');

// ç§»åŠ¨é…ç½®
const moveSpeed = 5;
let playerPos = {
  left: 20,
  top: (battleField.offsetHeight - 160) / battleField.offsetHeight * 100
};
let computerPos = {
  left: 80, // åˆå§‹å³20% = left 80%
  top: (battleField.offsetHeight - 160) / battleField.offsetHeight * 100
};

// æ˜¾ç¤ºæç¤ºæ–‡å­—
function showTxt(text) {
  msg.textContent = text;
  msg.style.opacity = 1;
  setTimeout(() => msg.style.opacity = 0, 1000);
}

// æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º
function updateHP() {
  const hp1 = Math.max(0, gameState.hp1);
  const hp2 = Math.max(0, gameState.hp2);
  document.getElementById('hp1').textContent = hp1;
  document.getElementById('hp2').textContent = hp2;
  document.getElementById('bar1').style.width = hp1 + '%';
  document.getElementById('bar2').style.width = hp2 + '%';
  
  // ä½è¡€é‡è­¦å‘Šï¼ˆå˜çº¢ï¼‰
  document.getElementById('bar1').className = `h-full ${hp1 < 30 ? 'bg-red-500' : 'bg-green-500'}`;
  document.getElementById('bar2').className = `h-full ${hp2 < 30 ? 'bg-red-500' : 'bg-green-500'}`;
}

// æ›´æ–°é˜²å¾¡å†·å´æ˜¾ç¤º
function updateDefenseCooldown() {
  if (gameState.defenseCooldown > 0) {
    defenseCooldownEl.textContent = `(é˜²å¾¡å†·å´: ${gameState.defenseCooldown}s)`;
  } else {
    defenseCooldownEl.textContent = '';
  }
}

// è·å–å½“å‰å…³å¡çš„ç”µè„‘å±æ€§ï¼ˆåŸºç¡€å€¼ + éš¾åº¦åŠ æˆï¼‰
function getEnemyConfig() {
  const levelCfg = gameState.levelConfig[gameState.currentLevel - 1];
  const diffBonus = gameState.difficultyBonus[gameState.difficulty];
  return {
    hp: levelCfg.hp + diffBonus.hp,
    minDmg: levelCfg.minDmg + diffBonus.dmg,
    maxDmg: levelCfg.maxDmg + diffBonus.dmg,
    attackSpeed: levelCfg.attackSpeed + diffBonus.attackSpeed,
    activeAttackInterval: levelCfg.activeAttackInterval - diffBonus.activeAttackInterval,
    moveSpeed: levelCfg.moveSpeed + diffBonus.moveSpeed
  };
}

// ç”µè„‘ä¸»åŠ¨ç§»åŠ¨ï¼ˆå‘ç©å®¶é è¿‘ï¼‰
function computerMove() {
  if (gameState.gameOver) return;
  
  const enemyCfg = getEnemyConfig();
  const fieldWidth = battleField.offsetWidth;
  
  // è®¡ç®—ç©å®¶å’Œç”µè„‘çš„åƒç´ ä½ç½®
  const playerLeftPx = (playerPos.left / 100) * fieldWidth;
  const computerLeftPx = (computerPos.left / 100) * fieldWidth;
  
  // ç”µè„‘å‘ç©å®¶æ–¹å‘ç§»åŠ¨ï¼ˆåªå·¦å³ç§»åŠ¨ï¼Œä¿æŒyè½´ä¸€è‡´ï¼‰
  const distance = playerLeftPx - computerLeftPx;
  const moveStep = (enemyCfg.moveSpeed / fieldWidth) * 100; // è½¬ç™¾åˆ†æ¯”
  
  // åªåœ¨è·ç¦»å¤§äº50pxæ—¶ç§»åŠ¨ï¼ˆé¿å…è´´è„¸ï¼‰
  if (Math.abs(distance) > 50) {
    if (distance > 0) {
      // ç©å®¶åœ¨å³ä¾§ï¼Œç”µè„‘å³ç§»
      if (computerLeftPx < fieldWidth - p2.offsetWidth - 10) {
        computerPos.left += moveStep;
      }
    } else {
      // ç©å®¶åœ¨å·¦ä¾§ï¼Œç”µè„‘å·¦ç§»
      if (computerLeftPx > 10) {
        computerPos.left -= moveStep;
      }
    }
    p2.style.left = computerPos.left + '%';
  }
}

// å¯åŠ¨ç”µè„‘ä¸»åŠ¨ç§»åŠ¨å®šæ—¶å™¨
function startComputerMove() {
  if (gameState.computerMoveTimer) {
    clearInterval(gameState.computerMoveTimer);
  }
  
  if (gameState.gameOver) return;
  
  // æ¯50msç§»åŠ¨ä¸€æ¬¡ï¼Œæ›´æµç•…
  gameState.computerMoveTimer = setInterval(() => {
    computerMove();
  }, 50);
}

// æ˜¾ç¤ºæ”»å‡»é¢„è­¦
function showAttackWarning() {
  attackWarning.style.display = 'block';
  setTimeout(() => {
    attackWarning.style.display = 'none';
  }, 800); // é¢„è­¦æ˜¾ç¤º0.8ç§’
}

// ç”µè„‘ä¸»åŠ¨æ”»å‡»å‡½æ•°
function computerActiveAttack() {
  if (gameState.gameOver || gameState.isAttacking) return;
  
  const enemyCfg = getEnemyConfig();
  // éšæœºåˆ¤å®šï¼šç®€å•éš¾åº¦70%æ”»å‡»æ¦‚ç‡ï¼Œä¸­ç­‰80%ï¼Œå›°éš¾90%
  const attackProbability = gameState.difficulty === 'easy' ? 0.7 : 
                            gameState.difficulty === 'medium' ? 0.8 : 0.9;
  
  if (Math.random() < attackProbability) {
    gameState.isAttacking = true;
    
    // å…ˆæ˜¾ç¤ºæ”»å‡»é¢„è­¦
    showAttackWarning();
    
    // é¢„è­¦ç»“æŸåå‘èµ·æ”»å‡»
    setTimeout(() => {
      if (gameState.gameOver) {
        gameState.isAttacking = false;
        return;
      }
      
      // ç”µè„‘ä¸»åŠ¨æ”»å‡»åŠ¨ç”»
      p2.classList.add('attack');
      setTimeout(() => p2.classList.remove('attack'), 400);
      
      // è®¡ç®—ä¼¤å®³ï¼ˆå¦‚æœç©å®¶é˜²å¾¡ï¼Œå‡å…80%ï¼‰
      const baseDmg = Math.floor(Math.random() * (enemyCfg.maxDmg - enemyCfg.minDmg + 1)) + enemyCfg.minDmg;
      const finalDmg = gameState.isDefending ? Math.floor(baseDmg * 0.2) : baseDmg;
      
      gameState.hp1 -= finalDmg;
      p1.classList.add('hurt');
      setTimeout(() => p1.classList.remove('hurt'), 400);
      
      if (gameState.isDefending) {
        showTxt(`ğŸ›¡ï¸ æˆåŠŸé˜²å¾¡ï¼ä»…å—åˆ° ${finalDmg} ç‚¹ä¼¤å®³ï¼`);
        gameState.isDefending = false;
        p1.classList.remove('defend');
      } else {
        showTxt(`âš ï¸ç”µè„‘ä¸»åŠ¨æ”»å‡»ï¼é€ æˆ ${finalDmg} ç‚¹ä¼¤å®³ï¼`);
      }
      
      updateHP();

      // æ£€æŸ¥ç©å®¶æ˜¯å¦å¤±è´¥
      if (gameState.hp1 <= 0) {
        showTxt(`ğŸ’€ç¬¬${gameState.currentLevel}å…³å¤±è´¥ï¼`);
        gameState.gameOver = true;
        clearInterval(gameState.activeAttackTimer);
        clearInterval(gameState.computerMoveTimer);
      }
      gameState.isAttacking = false;
    }, 800); // å’Œé¢„è­¦æ—¶é•¿ä¸€è‡´
  }
}

// å¯åŠ¨ç”µè„‘ä¸»åŠ¨æ”»å‡»å®šæ—¶å™¨
function startComputerActiveAttack() {
  // å…ˆæ¸…é™¤æ—§çš„å®šæ—¶å™¨ï¼Œé¿å…é‡å¤
  if (gameState.activeAttackTimer) {
    clearInterval(gameState.activeAttackTimer);
  }
  
  if (gameState.gameOver) return;
  
  const enemyCfg = getEnemyConfig();
  // æ¯éš”æŒ‡å®šæ—¶é—´è§¦å‘ä¸€æ¬¡ä¸»åŠ¨æ”»å‡»
  gameState.activeAttackTimer = setInterval(() => {
    computerActiveAttack();
  }, enemyCfg.activeAttackInterval);
}

// ç©å®¶é˜²å¾¡æŠ€èƒ½
function defend() {
  if (gameState.gameOver || gameState.defenseCooldown > 0) return;
  
  gameState.isDefending = true;
  p1.classList.add('defend');
  showTxt('ğŸ›¡ï¸ è¿›å…¥é˜²å¾¡çŠ¶æ€ï¼å‡å…80%ä¼¤å®³ï¼');
  
  // é˜²å¾¡æŒç»­1.5ç§’
  setTimeout(() => {
    if (!gameState.gameOver) {
      gameState.isDefending = false;
      p1.classList.remove('defend');
      showTxt('é˜²å¾¡çŠ¶æ€ç»“æŸï¼');
    }
  }, 1500);
  
  // å¯åŠ¨é˜²å¾¡å†·å´ï¼ˆ5ç§’ï¼‰
  gameState.defenseCooldown = 5;
  updateDefenseCooldown();
  
  gameState.defenseCooldownTimer = setInterval(() => {
    gameState.defenseCooldown--;
    updateDefenseCooldown();
    
    if (gameState.defenseCooldown <= 0) {
      clearInterval(gameState.defenseCooldownTimer);
      showTxt('âœ… é˜²å¾¡æŠ€èƒ½å·²å°±ç»ªï¼');
    }
  }, 1000);
}

// æ”»å‡»é€»è¾‘ï¼ˆç©å®¶æ”»å‡»ï¼‰
function attack() {
  if (gameState.gameOver || gameState.isAttacking) return;
  gameState.isAttacking = true;

  // ç©å®¶æ”»å‡»ï¼ˆä¼¤å®³éšå…³å¡æå‡ï¼ŒåŸºç¡€8-18ï¼‰
  const playerDmgMin = 8 + (gameState.currentLevel - 1) * 1;
  const playerDmgMax = 18 + (gameState.currentLevel - 1) * 1;
  const dmg = Math.floor(Math.random() * (playerDmgMax - playerDmgMin + 1)) + playerDmgMin;
  
  // æ‰§è¡Œæ”»å‡»åŠ¨ç”»
  p1.classList.add('attack');
  setTimeout(() => p1.classList.remove('attack'), 400);
  
  // æ‰£è¡€
  gameState.hp2 -= dmg;
  p2.classList.add('hurt');
  setTimeout(() => p2.classList.remove('hurt'), 400);
  showTxt(`ä½ é€ æˆ ${dmg} ç‚¹ä¼¤å®³ï¼`);
  updateHP();

  // æ£€æŸ¥æ˜¯å¦å‡»è´¥æ•Œäºº
  if (gameState.hp2 <= 0) {
    // é€šå…³å½“å‰å…³å¡
    if (gameState.currentLevel < 5) {
      showTxt(`ğŸ‰ç¬¬${gameState.currentLevel}å…³é€šå…³ï¼`);
      gameState.gameOver = true;
      clearInterval(gameState.activeAttackTimer);
      clearInterval(gameState.computerMoveTimer);
      // 2ç§’åè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€å…³
      setTimeout(() => {
        gotoLevel(gameState.currentLevel + 1);
      }, 2000);
    } else {
      // é€šå…³æ‰€æœ‰å…³å¡
      showTxt(`ğŸ†æ­å–œé€šå…³æ‰€æœ‰å…³å¡ï¼`);
      gameState.gameOver = true;
      clearInterval(gameState.activeAttackTimer);
      clearInterval(gameState.computerMoveTimer);
    }
    gameState.isAttacking = false;
    return;
  }

  // ç”µè„‘åå‡»ï¼ˆæ ¹æ®å½“å‰å…³å¡+éš¾åº¦é…ç½®ï¼‰
  const enemyCfg = getEnemyConfig();
  // åå‡»å‰å…ˆæ˜¾ç¤ºé¢„è­¦
  showAttackWarning();
  
  setTimeout(() => {
    if (gameState.gameOver) {
      gameState.isAttacking = false;
      return;
    }
    p2.classList.add('attack');
    setTimeout(() => p2.classList.remove('attack'), 400);
    
    // ç”µè„‘ä¼¤å®³ï¼ˆå…³å¡+éš¾åº¦åŠ æˆï¼Œé˜²å¾¡å‡å…80%ï¼‰
    const baseDmg = Math.floor(Math.random() * (enemyCfg.maxDmg - enemyCfg.minDmg + 1)) + enemyCfg.minDmg;
    const finalDmg = gameState.isDefending ? Math.floor(baseDmg * 0.2) : baseDmg;
    
    gameState.hp1 -= finalDmg;
    p1.classList.add('hurt');
    setTimeout(() => p1.classList.remove('hurt'), 400);
    
    if (gameState.isDefending) {
      showTxt(`ğŸ›¡ï¸ æˆåŠŸé˜²å¾¡åå‡»ï¼ä»…å—åˆ° ${finalDmg} ç‚¹ä¼¤å®³ï¼`);
      gameState.isDefending = false;
      p1.classList.remove('defend');
    } else {
      showTxt(`ç”µè„‘åå‡» ${finalDmg} ç‚¹ï¼`);
    }
    
    updateHP();

    // æ£€æŸ¥ç©å®¶æ˜¯å¦å¤±è´¥
    if (gameState.hp1 <= 0) {
      showTxt(`ğŸ’€ç¬¬${gameState.currentLevel}å…³å¤±è´¥ï¼`);
      gameState.gameOver = true;
      clearInterval(gameState.activeAttackTimer);
      clearInterval(gameState.computerMoveTimer);
    }
    gameState.isAttacking = false;
  }, enemyCfg.attackSpeed + 800); // åŠ ä¸Šé¢„è­¦æ—¶é—´
}

// é‡ç½®æ¸¸æˆï¼ˆä¿ç•™å½“å‰å…³å¡å’Œéš¾åº¦ï¼‰
function resetGame() {
  const enemyCfg = getEnemyConfig();
  gameState.hp1 = 100;                // ç©å®¶è¡€é‡å›ºå®š100
  gameState.hp2 = enemyCfg.hp;        // ç”µè„‘è¡€é‡éšå…³å¡/éš¾åº¦å˜åŒ–
  gameState.gameOver = false;
  gameState.isAttacking = false;
  gameState.isDefending = false;
  gameState.defenseCooldown = 0;
  
  // é‡ç½®ç©å®¶ä½ç½®
  playerPos = {
    left: 20,
    top: (battleField.offsetHeight - 160) / battleField.offsetHeight * 100
  };
  p1.style.left = playerPos.left + '%';
  p1.style.top = playerPos.top + '%';
  p1.classList.remove('defend');
  
  // é‡ç½®ç”µè„‘ä½ç½®
  computerPos = {
    left: 80,
    top: (battleField.offsetHeight - 160) / battleField.offsetHeight * 100
  };
  p2.style.left = computerPos.left + '%';
  p2.style.top = computerPos.top + '%';
  
  // æ¸…é™¤å†·å´å®šæ—¶å™¨
  if (gameState.defenseCooldownTimer) {
    clearInterval(gameState.defenseCooldownTimer);
  }
  
  updateHP();
  updateDefenseCooldown();
  showTxt('é‡æ–°å¼€å§‹ï¼');
  
  // é‡å¯ç”µè„‘ä¸»åŠ¨æ”»å‡»å’Œç§»åŠ¨
  startComputerActiveAttack();
  startComputerMove();
}

// è®¾ç½®éš¾åº¦
function setDifficulty(diff) {
  // æ›´æ–°æ ·å¼
  difficultyBtns.forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.difficulty-${diff}`).classList.add('active');
  
  // æ›´æ–°æ¸¸æˆçŠ¶æ€
  gameState.difficulty = diff;
  resetGame(); // é‡ç½®å½“å‰å…³å¡
  showTxt(`éš¾åº¦å·²åˆ‡æ¢ä¸ºï¼š${diff === 'easy' ? 'ç®€å•' : diff === 'medium' ? 'ä¸­ç­‰' : 'å›°éš¾'}`);
}

// è·³è½¬åˆ°æŒ‡å®šå…³å¡
function gotoLevel(level) {
  if (level < 1 || level > 5) return;
  
  // æ›´æ–°å…³å¡æŒ‰é’®æ ·å¼
  levelBtns.forEach(btn => btn.classList.remove('active'));
  levelBtns[level - 1].classList.add('active');
  
  // æ›´æ–°æ¸¸æˆçŠ¶æ€
  gameState.currentLevel = level;
  currentLevelEl.textContent = level;
  
  // é‡ç½®æ¸¸æˆï¼ˆåŠ è½½å½“å‰å…³å¡+éš¾åº¦çš„é…ç½®ï¼‰
  resetGame();
  showTxt(`è¿›å…¥ç¬¬${level}å…³ï¼`);
}

// å…¨æ–¹å‘ç§»åŠ¨å‡½æ•°
function movePlayer(direction) {
  if (gameState.gameOver) return;

  const fieldWidth = battleField.offsetWidth;
  const fieldHeight = battleField.offsetHeight;
  const playerWidth = p1.offsetWidth;
  const playerHeight = p1.offsetHeight;
  const currentLeftPx = (playerPos.left / 100) * fieldWidth;
  const currentTopPx = (playerPos.top / 100) * fieldHeight;

  switch(direction) {
    case 'left':
      if (currentLeftPx > 10) {
        playerPos.left -= (moveSpeed / fieldWidth) * 100;
        p1.style.left = playerPos.left + '%';
      }
      break;
    case 'right':
      if (currentLeftPx < fieldWidth - playerWidth - 10) {
        playerPos.left += (moveSpeed / fieldWidth) * 100;
        p1.style.left = playerPos.left + '%';
      }
      break;
    case 'up':
      if (currentTopPx > 10) {
        playerPos.top -= (moveSpeed / fieldHeight) * 100;
        p1.style.top = playerPos.top + '%';
      }
      break;
    case 'down':
      if (currentTopPx < fieldHeight - playerHeight - 10) {
        playerPos.top += (moveSpeed / fieldHeight) * 100;
        p1.style.top = playerPos.top + '%';
      }
      break;
  }
}

// é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ˆæ–°å¢Shifté˜²å¾¡ï¼‰
document.addEventListener('keydown', (e) => {
  if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space', 'Shift'].includes(e.code)) {
    e.preventDefault();
  }

  if (e.code === 'ArrowLeft') movePlayer('left');
  if (e.code === 'ArrowRight') movePlayer('right');
  if (e.code === 'ArrowUp') movePlayer('up');
  if (e.code === 'ArrowDown') movePlayer('down');
  if (e.code === 'Space') attack();
  if (e.code === 'KeyR') resetGame();
  if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') defend(); // å·¦å³Shiftéƒ½å¯é˜²å¾¡
});

// åˆå§‹åŒ–æ¸¸æˆ
(function initGame() {
  const enemyCfg = getEnemyConfig();
  gameState.hp2 = enemyCfg.hp;
  // åˆå§‹åŒ–ç”µè„‘ä½ç½®
  p2.style.left = computerPos.left + '%';
  p2.style.top = computerPos.top + '%';
  
  updateHP();
  updateDefenseCooldown();
  showTxt('æŒ‰â†‘â†“â†â†’ç§»åŠ¨ï¼Œç©ºæ ¼æ”»å‡»ï¼Shifté˜²å¾¡ï¼', 2000);
  // å¯åŠ¨ç”µè„‘ä¸»åŠ¨æ”»å‡»å’Œç§»åŠ¨
  startComputerActiveAttack();
  startComputerMove();
})();
</script>
</body>
</html>