<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¯†å®¤é€ƒè„± Â· å®Œç¾100å…³</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; }
    body {
      background: #0d0d1a;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
    }
    h1 {
      margin: 15px 0;
      text-align: center;
      font-size: 1.8rem;
      color: #ffcc00;
      text-shadow: 0 0 10px rgba(255,204,0,0.6);
    }
    #game-container {
      width: 95%;
      max-width: 800px;
      background: #1a1a2e;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      position: relative;
    }
    #room-view {
      height: 400px;
      position: relative;
      background-size: cover;
      background-position: center;
    }
    .room-bg.living   { background: linear-gradient(rgba(30,20,10,0.8), rgba(30,20,10,0.8)), #d7ccc8; }
    .room-bg.bedroom  { background: linear-gradient(rgba(40,20,30,0.85), rgba(40,20,30,0.85)), #efebe9; }
    .room-bg.basement { background: linear-gradient(rgba(10,10,20,0.95), rgba(10,10,20,0.95)), #37474f; }
    .room-bg.attic    { background: linear-gradient(rgba(20,15,10,0.9), rgba(20,15,10,0.9)), #bcaaa4; }

    /* å®¶å…·è£…é¥°ï¼ˆä»…è§†è§‰ï¼‰ */
    .furniture {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
      z-index: 1;
      font-size: 12px;
      color: #ccc;
    }
    .furniture .icon {
      margin-bottom: 4px;
      font-size: 24px;
    }

    .interactive {
      position: absolute;
      cursor: pointer;
      font-size: 28px;
      transition: transform 0.2s;
      user-select: none;
      z-index: 10;
    }
    .interactive:hover { transform: scale(1.25); }

    #inventory-bar {
      padding: 12px;
      background: #0f3460;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .item-icon {
      background: #16213e;
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    #level-info {
      padding: 10px;
      text-align: center;
      background: #162447;
      font-size: 1.1rem;
    }
    #message {
      padding: 10px;
      text-align: center;
      min-height: 24px;
      color: #a5d6a7;
      font-weight: bold;
    }
    #password-input {
      display: none;
      padding: 12px;
      text-align: center;
      background: #1b263b;
    }
    #password-input input {
      padding: 8px;
      font-size: 16px;
      width: 140px;
      margin-right: 10px;
      border-radius: 4px;
      border: 1px solid #444;
    }
    button {
      padding: 8px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #2980b9; }

    #win-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: gold;
    }
    #win-screen h2 {
      font-size: 3rem;
      margin-bottom: 20px;
      text-shadow: 0 0 20px gold;
    }
    #win-screen button {
      padding: 12px 30px;
      background: gold;
      color: #1a1a2e;
      border: none;
      border-radius: 50px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      font-size: 1.1rem;
    }

    #hint-btn {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: #ff9800;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      font-size: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    #hint-btn:hover { background: #f57c00; }
  </style>
</head>
<body>

<h1>ğŸ” å¯†å®¤é€ƒè„± Â· å®Œç¾100å…³</h1>

<div id="game-container">
  <div id="room-view" class="room-bg living"></div>
  <div id="level-info">ç¬¬ <span id="current-level">1</span> å…³ / 100</div>
  <div id="message">æ¢ç´¢æˆ¿é—´ï¼Œå¯»æ‰¾çº¿ç´¢ï¼</div>
  <div id="password-input">
    <input type="text" id="pwd" maxlength="6" placeholder="è¾“å…¥å¯†ç " autocomplete="off" />
    <button onclick="submitPassword()">ç¡®è®¤</button>
    <div id="attempts" style="color:#ff9999; margin-top:6px; font-size:14px;"></div>
  </div>
  <div id="inventory-bar">
    <span>ğŸ’ èƒŒåŒ…ï¼š</span>
    <div id="inventory-list">ç©º</div>
  </div>
  <div id="hint-btn" title="ç‚¹å‡»è·å–æç¤º">ğŸ’¡</div>
</div>

<div id="win-screen">
  <h2>ğŸ† çœŸæ­£çš„é€ƒè„±å¤§å¸ˆï¼</h2>
  <p>ä½ ç”¨æ™ºæ…§ç ´è§£äº†å…¨éƒ¨100é“è°œé¢˜ï¼</p>
  <button onclick="resetGame()">å†æŒ‘æˆ˜ä¸€æ¬¡</button>
</div>

<script>
const ITEMS = {
  key: { name: 'é‡‘é’¥åŒ™', icon: 'ğŸ”‘' },
  silverKey: { name: 'é“¶é’¥åŒ™', icon: 'ğŸ—ï¸' },
  hammer: { name: 'é“é”¤', icon: 'ğŸ”¨' },
  flashlight: { name: 'æ‰‹ç”µç­’', icon: 'ğŸ”¦' },
  battery: { name: 'ç”µæ± ', icon: 'ğŸ”‹' },
  magnifier: { name: 'æ”¾å¤§é•œ', icon: 'ğŸ”' },
  notebook: { name: 'æ—¥è®°æœ¬', icon: 'ğŸ““' },
  note: { name: 'å¯†ç çº¸', icon: 'ğŸ“„' }
};

const ROOMS = ['living', 'bedroom', 'basement', 'attic'];

const LEVELS = [
  // ç¬¬1å…³ï¼šå®¢å… - åªæœ‰è¡£æŸœ
  {
    room: 'living',
    hotspots: [
      { type: 'wardrobe', x: '40%', y: '50%', content: 'key', message: 'è¡£æŸœé‡Œæœ‰ä¸€æŠŠé‡‘é’¥åŒ™ï¼' }
    ]
  },
  // ç¬¬2å…³ï¼šå®¢å… - å¢™ç”» + å¼€é—¨
  {
    room: 'living',
    hotspots: [{ type: 'painting', x: '70%', y: '30%', message: 'ç”»åé¢æœ‰ä¸ªé”å­”ï¼' }],
    action: { type: 'use', need: 'key', to: 'bedroom' },
    hints: ["ç”¨é‡‘é’¥åŒ™å¼€é—¨", "è¯•è¯•ç‚¹å‡»é—¨"]
  },
  // âœ… ç¬¬3å…³ï¼šå§å®¤ - æœ‰çœŸå®å®¶å…· + æŠ½å±‰
  {
    room: 'bedroom',
    hotspots: [
      { type: 'drawer', x: '25%', y: '65%', content: 'flashlight', message: 'åºŠå¤´æŸœçš„æŠ½å±‰æ²¡é”ï¼Œå¯ä»¥æ‰“å¼€ï¼' }
    ]
  },
  // ç¬¬4å…³ï¼šå¯†ç é’Ÿè¡¨
  {
    room: 'bedroom',
    hotspots: [{ type: 'clock', x: '60%', y: '20%', clue: '520', message: 'è€é’Ÿåœåœ¨5:20' }],
    action: { type: 'password', answer: '520' },
    hints: ["æ—¶é—´å°±æ˜¯å¯†ç ", "5ç‚¹20åˆ†", "è¯•è¯•520"]
  },
  // ç¬¬5å…³ï¼šæ¨¡ç³Šæ—¥è®°
  {
    room: 'bedroom',
    hotspots: [{ type: 'notebook', x: '35%', y: '70%', requires: 'magnifier', text: 'ä»–è¯´äº†520ï¼Œæˆ‘æ°¸è¿œè®°å¾—ã€‚', message: 'å­—è¿¹æ¨¡ç³Šâ€¦' }],
    action: { type: 'password', answer: '520' },
    hints: ["çˆ±æƒ…æ•°å­—", "ä¸­æ–‡è°éŸ³", "520=æˆ‘çˆ±ä½ "]
  },
  // åç»­å…³å¡...
  ...Array.from({ length: 95 }, (_, i) => {
    const n = i + 6;
    return {
      room: ROOMS[n % 4],
      hotspots: [],
      action: null,
      hints: []
    };
  })
];

let currentLevel = parseInt(localStorage.getItem('escapeFinalLevel')) || 0;
let inventory = JSON.parse(localStorage.getItem('escapeFinalInventory')) || [];
let passwordAttempts = 0;
let hintLevel = 0;
const MAX_ATTEMPTS = 3;

if (currentLevel >= 100) {
  document.getElementById('win-screen').style.display = 'flex';
}

function showMessage(text) {
  document.getElementById('message').innerText = text;
  setTimeout(() => {
    if (currentLevel < 100) document.getElementById('message').innerText = '';
  }, 2500);
}

function hasItem(itemKey) { return inventory.includes(itemKey); }
function consumeItem(itemKey) {
  inventory = inventory.filter(i => i !== itemKey);
  saveProgress();
  updateInventoryUI();
}
function collectItemNow(itemKey) {
  if (!hasItem(itemKey)) {
    inventory.push(itemKey);
    saveProgress();
    updateInventoryUI();
    showMessage(`è·å¾—äº†ã€${ITEMS[itemKey].name}ã€‘ï¼`);
    if (currentLevel === 0) setTimeout(nextLevel, 1000);
  }
}
function saveProgress() {
  localStorage.setItem('escapeFinalLevel', currentLevel.toString());
  localStorage.setItem('escapeFinalInventory', JSON.stringify(inventory));
}
function updateInventoryUI() {
  const list = document.getElementById('inventory-list');
  list.innerHTML = inventory.length ? '' : 'ç©º';
  inventory.forEach(key => {
    const div = document.createElement('div');
    div.className = 'item-icon';
    div.innerHTML = `<span>${ITEMS[key].icon}</span> ${ITEMS[key].name}`;
    list.appendChild(div);
  });
}

function tryOpenDoor() {
  const level = LEVELS[currentLevel];
  if (!level.action) return;

  if (level.action.type === 'use' || level.action.type === 'use_consume') {
    if (hasItem(level.action.need)) {
      if (level.action.type === 'use_consume') {
        consumeItem(level.action.need);
        showMessage(`ä½¿ç”¨å¹¶æ¶ˆè€—äº†ã€${ITEMS[level.action.need].name}ã€‘ï¼`);
      } else {
        showMessage(`ä½¿ç”¨ã€${ITEMS[level.action.need].name}ã€‘æˆåŠŸå¼€é—¨ï¼`);
      }
      setTimeout(nextLevel, 1200);
    } else {
      showMessage(`éœ€è¦ã€${ITEMS[level.action.need].name}ã€‘æ‰èƒ½å¼€é—¨ï¼`);
    }
  } else if (level.action.type === 'password') {
    document.getElementById('password-input').style.display = 'block';
    document.getElementById('pwd').focus();
    updateAttemptsUI();
  }
}

function submitPassword() {
  const input = document.getElementById('pwd').value.trim();
  const level = LEVELS[currentLevel];
  if (!level.action || !input) return;

  if (input === level.action.answer) {
    showMessage('å¯†ç æ­£ç¡®ï¼é—¨å¼€äº†ï¼');
    passwordAttempts = 0;
    setTimeout(nextLevel, 1000);
  } else {
    passwordAttempts++;
    if (passwordAttempts >= MAX_ATTEMPTS) {
      showMessage("é”™è¯¯å¤ªå¤šï¼é€€å›ä¸Šä¸€å…³...");
      setTimeout(() => {
        currentLevel = Math.max(0, currentLevel - 1);
        passwordAttempts = 0;
        renderRoom();
      }, 2000);
    } else {
      showMessage('å¯†ç é”™è¯¯ï¼');
      document.getElementById('pwd').value = '';
      updateAttemptsUI();
    }
  }
}

function updateAttemptsUI() {
  document.getElementById('attempts').innerText = 
    passwordAttempts > 0 ? `å·²é”™ ${passwordAttempts}/${MAX_ATTEMPTS} æ¬¡` : '';
}

function nextLevel() {
  currentLevel++;
  saveProgress();
  if (currentLevel >= 100) {
    document.getElementById('win-screen').style.display = 'flex';
    return;
  }
  renderRoom();
}

document.getElementById('hint-btn').onclick = function() {
  const level = LEVELS[currentLevel];
  const hints = level.hints || ["ä»”ç»†æ£€æŸ¥æ¯ä¸ªè§’è½ï¼", "ç‚¹å‡»å¯ç–‘ç‰©ä½“", "ç­”æ¡ˆå°±åœ¨æˆ¿é—´é‡Œâ€¦"];
  if (hintLevel < hints.length) {
    showMessage(hints[hintLevel]);
    hintLevel++;
    this.style.opacity = '0.5';
    setTimeout(() => this.style.opacity = '1', 5000);
  }
};

// âœ… æ ¸å¿ƒï¼šæ¸²æŸ“æˆ¿é—´ + å®¶å…·
function renderRoom() {
  const level = LEVELS[currentLevel];
  if (!level) return;

  document.getElementById('current-level').textContent = currentLevel + 1;
  document.getElementById('password-input').style.display = 'none';
  passwordAttempts = 0;
  hintLevel = 0;
  document.getElementById('attempts').innerText = '';

  const roomView = document.getElementById('room-view');
  roomView.className = 'room-bg ' + level.room;
  roomView.innerHTML = '';

  // ========== å§å®¤ä¸“å±å®¶å…·ï¼ˆç¬¬3å…³ç­‰ï¼‰==========
  if (level.room === 'bedroom') {
    // ğŸ›ï¸ åºŠ
    const bed = document.createElement('div');
    bed.className = 'furniture';
    bed.style.left = '8%';
    bed.style.bottom = '15%';
    bed.innerHTML = '<div class="icon">ğŸ›ï¸</div><div>åºŠ</div>';
    roomView.appendChild(bed);

    // ğŸ“š ä¹¦æ¶
    const shelf = document.createElement('div');
    shelf.className = 'furniture';
    shelf.style.left = '45%';
    shelf.style.top = '10%';
    shelf.innerHTML = '<div class="icon">ğŸ“š</div><div>ä¹¦æ¶</div>';
    roomView.appendChild(shelf);

    // ğŸª é•œå­
    const mirror = document.createElement('div');
    mirror.className = 'furniture';
    mirror.style.right = '12%';
    mirror.style.top = '25%';
    mirror.innerHTML = '<div class="icon">ğŸª</div><div>é•œå­</div>';
    roomView.appendChild(mirror);
  }

  // ========== é—¨ ==========
  if (level.action) {
    const door = document.createElement('div');
    door.className = 'interactive';
    door.style.right = '40px';
    door.style.bottom = '80px';
    door.style.fontSize = '40px';
    door.innerText = 'ğŸšª';
    door.onclick = tryOpenDoor;
    roomView.appendChild(door);
  } else {
    const deco = document.createElement('div');
    deco.style.position = 'absolute';
    deco.style.right = '40px';
    deco.style.bottom = '80px';
    deco.style.fontSize = '40px';
    deco.style.opacity = '0.4';
    deco.style.pointerEvents = 'none';
    deco.innerText = 'ğŸšª';
    roomView.appendChild(deco);
  }

  // ========== å¯äº¤äº’çƒ­ç‚¹ ==========
  if (level.hotspots) {
    level.hotspots.forEach(hotspot => {
      const el = document.createElement('div');
      el.className = 'interactive';
      el.style.left = hotspot.x;
      el.style.top = hotspot.y;
      el.style.fontSize = '28px';

      if (hotspot.type === 'wardrobe') el.innerText = 'ğŸ§º';
      else if (hotspot.type === 'drawer') el.innerText = 'ğŸ“¦';
      else if (hotspot.type === 'bookshelf') el.innerText = 'ğŸ“š';
      else if (hotspot.type === 'clock') el.innerText = 'â°';
      else if (hotspot.type === 'mirror') el.innerText = 'ğŸª';
      else if (hotspot.type === 'painting') el.innerText = 'ğŸ–¼ï¸';
      else if (hotspot.type === 'notebook') el.innerText = 'ğŸ““';

      el.onclick = () => {
        if (hotspot.content && !inventory.includes(hotspot.content)) {
          collectItemNow(hotspot.content);
        } else if (hotspot.clue) {
          showMessage(hotspot.message || `å‘ç°çº¿ç´¢ï¼š${hotspot.clue}`);
        } else if (hotspot.requires) {
          if (hasItem(hotspot.requires)) {
            showMessage(hotspot.text);
          } else {
            showMessage(`éœ€è¦ã€${ITEMS[hotspot.requires].name}ã€‘æ‰èƒ½æŸ¥çœ‹`);
          }
        } else {
          showMessage(hotspot.message || 'æ²¡ä»€ä¹ˆç‰¹åˆ«çš„');
        }
      };

      roomView.appendChild(el);
    });
  }

  updateInventoryUI();

  // åˆå§‹æç¤ºï¼ˆä»…ç¬¬1ã€3å…³ï¼‰
  if (currentLevel === 0) {
    setTimeout(() => showMessage('ç¬¬1å…³ï¼šç‚¹å‡» ğŸ§º è¡£æŸœ æŸ¥æ‰¾çº¿ç´¢ï¼'), 800);
  } else if (currentLevel === 2) {
    setTimeout(() => showMessage('ç¬¬3å…³ï¼šç‚¹å‡» ğŸ“¦ æŠ½å±‰ æŸ¥æ‰¾æ‰‹ç”µç­’ï¼'), 800);
  }
}

function resetGame() {
  localStorage.clear();
  currentLevel = 0;
  inventory = [];
  passwordAttempts = 0;
  hintLevel = 0;
  document.getElementById('win-screen').style.display = 'none';
  renderRoom();
  showMessage('æ¸¸æˆå·²é‡ç½®ï¼');
}

document.getElementById('pwd').addEventListener('keypress', e => {
  if (e.key === 'Enter') submitPassword();
});

renderRoom();
</script>

</body>
</html>